"""
Minecraft Controller - –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∫–æ–º–∞–Ω–¥—ã –∏–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
"""
from flask import Flask, request, jsonify
from flask_cors import CORS
import keyboard
import time
import pyautogui
import threading
import pystray
from PIL import Image, ImageDraw
from pystray import MenuItem as item

app = Flask(__name__)
CORS(app)

pyautogui.FAILSAFE = False

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
server_running = False
icon = None


def create_icon_image():
    """–°–æ–∑–¥–∞—Ç—å –∏–∫–æ–Ω–∫—É –¥–ª—è —Ç—Ä–µ—è"""
    # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç—É—é –∏–∫–æ–Ω–∫—É 64x64
    image = Image.new('RGB', (64, 64), color='#1a1d29')
    dc = ImageDraw.Draw(image)
    
    # –†–∏—Å—É–µ–º –∫—Ä—É–≥
    dc.ellipse([8, 8, 56, 56], fill='#60a5fa', outline='#a78bfa', width=3)
    
    # –†–∏—Å—É–µ–º "MC"
    dc.text((18, 22), "MC", fill='white')
    
    return image


def send_minecraft_command(command):
    """–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É –≤ Minecraft"""
    try:
        # –û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç (T)
        keyboard.press_and_release('t')
        time.sleep(0.1)
        
        # –í—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É
        pyautogui.write(command, interval=0.01)
        time.sleep(0.05)
        
        # –û—Ç–ø—Ä–∞–≤–∏—Ç—å (Enter)
        keyboard.press_and_release('enter')
        time.sleep(0.1)
        
        return True
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥—ã: {e}")
        return False


@app.route('/command', methods=['POST'])
def execute_command():
    """API endpoint –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥"""
    try:
        data = request.json
        command = data.get('command')
        
        if not command:
            return jsonify({'error': '–ö–æ–º–∞–Ω–¥–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞'}), 400
        
        print(f"–í—ã–ø–æ–ª–Ω—è—é –∫–æ–º–∞–Ω–¥—É: {command}")
        success = send_minecraft_command(command)
        
        if success:
            return jsonify({'status': 'success', 'command': command})
        else:
            return jsonify({'error': '–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã'}), 500
            
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞: {e}")
        return jsonify({'error': str(e)}), 500


@app.route('/status', methods=['GET'])
def status():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–µ—Ä–∞"""
    return jsonify({'status': 'online', 'message': 'MC Controller —Ä–∞–±–æ—Ç–∞–µ—Ç'})


def run_flask():
    """–ó–∞–ø—É—Å—Ç–∏—Ç—å Flask —Å–µ—Ä–≤–µ—Ä"""
    global server_running
    server_running = True
    app.run(host='0.0.0.0', port=5000, debug=False, use_reloader=False)


def on_quit(icon, item):
    """–í—ã—Ö–æ–¥ –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"""
    global server_running
    server_running = False
    icon.stop()


def setup_tray():
    """–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∏–∫–æ–Ω–∫—É –≤ —Ç—Ä–µ–µ"""
    global icon
    
    image = create_icon_image()
    
    menu = pystray.Menu(
        item('MC Controller', lambda: None, enabled=False),
        item('–°—Ç–∞—Ç—É—Å: –†–∞–±–æ—Ç–∞–µ—Ç', lambda: None, enabled=False),
        pystray.Menu.SEPARATOR,
        item('–í—ã—Ö–æ–¥', on_quit)
    )
    
    icon = pystray.Icon("mc_controller", image, "MC Controller", menu)
    icon.run()


if __name__ == '__main__':
    print("=" * 50)
    print("üéÆ Minecraft Controller –∑–∞–ø—É—â–µ–Ω!")
    print("=" * 50)
    print("–°–µ—Ä–≤–µ—Ä: http://localhost:5000")
    print("–ò–∫–æ–Ω–∫–∞ –≤ —Ç—Ä–µ–µ: MC Controller")
    print("–û—Ç–∫—Ä–æ–π index.html –≤ –±—Ä–∞—É–∑–µ—Ä–µ")
    print("=" * 50)
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º Flask –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
    flask_thread = threading.Thread(target=run_flask, daemon=True)
    flask_thread.start()
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –∏–∫–æ–Ω–∫—É –≤ —Ç—Ä–µ–µ (–±–ª–æ–∫–∏—Ä—É—é—â–∏–π –≤—ã–∑–æ–≤)
    setup_tray()

